#
# According to https://docs.aws.amazon.com/cli/latest/reference/ec2/modify-image-attribute.html
#
# To enable the SriovNetSupport enhanced networking attribute of an image, enable SriovNetSupport on an instance and create 
# an AMI from the instance.
#
---

- name: Tag image without SRIOV, keep it too
  ec2_tag:
    region: "{{ region }}"
    resource: "{{ ami_image_id }}"
    state: present
    tags:
      Name: "No SRIOV {{ ami_name }}"
      Nuage: "NSG-V"
      Version: "{{ ami_version }}"

- name: Make sure there is a default VPC
  ignore_errors: true
  local_action: command aws ec2 create-default-vpc --region {{region}}

- name: Create a dummy t2.micro instance in {{region}} based on AMI {{ami_image_id}}; only way to set srIov flag
  ec2_instance:
    name: dummy
    region: "{{ region }}"
    state: "present" # stopped
    image_id: "{{ ami_image_id }}"
    wait: yes  # no - testing 'no' to see if we can stop it sooner, before any damage is done? Nope
    volumes:
      - device_name: "/dev/sda1"
        ebs: 
          delete_on_termination: true
  register: dummy_ami

- debug: var=dummy_ami

- name: Stop the dummy instance
  ec2_instance:
    region: "{{ region }}"
    instance_ids: [ "{{ dummy_ami.instances[0].instance_id }}" ]
    state: "stopped"
    wait: yes
  register: dummy_ami_stopped

- name: Manually set SRIOV support enabled
  local_action: command aws ec2 modify-instance-attribute --instance-id "{{ dummy_ami.instances[0].instance_id }}" 
                 --region {{ region }} --sriov-net-support simple

- name: Create AMI based on dummy instance, set sriov flag and tag item
  ec2_ami:
    region: "{{ region }}"
    instance_id: "{{ dummy_ami.instances[0].instance_id }}"
    wait: yes
    name: "SRIOV {{ ami_name }}"
    sriov_net_support: "simple" # Set this flag for better networking performance? Doesn't work
    tags:
      Name: "SRIOV {{ ami_name }}"
      Nuage: "NSG-V"
      Version: "{{ ami_version }}"
  register: ami

- debug: var=ami

- name: Delete the dummy instance
  ec2_instance:
    region: "{{ region }}"
    instance_ids: [ "{{ dummy_ami.instances[0].instance_id }}" ]
    state: absent

#- name: Delete the imported image without sriov enabled
#  ec2_ami:
#    region: "{{ region }}"
#    image_id: "{{ ami_image_id }}"
#    delete_snapshot: True
#    state: absent
