#
# Mounts an S3 bucket to Docker host using s3 Fuse Filesystem, to cache downloaded files from ALED
#

---
- block:
  - name: Create AWS bucket in {{_region}}, include region name; uses DNS towards Docker host
    tags: check # Tests AWS credentials and DNS
    aws_s3:
      bucket: "{{ _bucket_name }}"
      mode: create
      permission: private # public-read
      # dualstack: yes # Added in Ansible 2.7

  - name: Create download directory to mount
    file: path={{downloads_folder}} state=directory

  - name: Create dir for temporary cache; don't use /tmp as the container has limited disk
    file: path="{{_s3_cache_path}}" state=directory

  - name: Mount the bucket to {{ downloads_folder }}, depends on /dev/fuse device being loaded and passed to the container
    ignore_errors: true  # Fails when re-mounting
    local_action: command s3fs "{{ _bucket_name }}" "{{ downloads_folder }}" -o use_rrs=1 -o use_cache="{{_s3_cache_path}}"

  vars:
    _region: "{{ aws_region | default( AWS_REGION ) }}"
    _bucket_name: "{{ awslab_bucket }}-{{ _region }}"
    _s3_cache_path: "{{ home_dir }}/s3-cache"

  environment:
    AWS_ACCESS_KEY_ID: "{{ AWS_ACCESS_KEY_ID }}"
    AWS_SECRET_ACCESS_KEY: "{{ AWS_SECRET_ACCESS_KEY }}"
    # s3fs uses different names...
    AWSACCESSKEYID: "{{ AWS_ACCESS_KEY_ID }}"
    AWSSECRETACCESSKEY: "{{ AWS_SECRET_ACCESS_KEY }}"
    AWS_REGION: "{{ _region }}"
    http_proxy: "{{ http_proxy | default('') }}"
    https_proxy: "{{ http_proxy | default('') }}"
    no_proxy: "{{ no_proxy|default('') }}"
